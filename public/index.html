<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blackhole Core MCP</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding-top: 2rem;
            background-color: #f8f9fa;
        }
        .header {
            margin-bottom: 2rem;
            text-align: center;
        }
        .card {
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .results-container {
            max-height: 500px;
            overflow-y: auto;
        }
        .result-item {
            margin-bottom: 1rem;
            padding: 1rem;
            border-radius: 5px;
            background-color: #f1f1f1;
        }
        .nav-tabs {
            margin-bottom: 1rem;
        }
        #loading {
            display: none;
            text-align: center;
            margin: 2rem 0;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Blackhole Core MCP</h1>
            <p class="lead">A modular AI-powered framework for processing multimodal data</p>
            <div class="mt-3">
                <button id="testConnectionBtn" class="btn btn-primary">Test Backend Connection</button>
                <div id="testConnectionResult" class="mt-2"></div>
                <div class="mt-2">
                    <a href="cors-test.html" class="btn btn-outline-secondary" target="_blank">CORS Test Page</a>
                    <a href="cors-headers-test.html" class="btn btn-outline-secondary" target="_blank">CORS Headers Test</a>
                    <a href="direct-test.html" class="btn btn-outline-secondary" target="_blank">Direct Connection Test</a>
                    <a href="proxy-test.html" class="btn btn-outline-secondary" target="_blank">Proxy Test</a>
                    <a href="function-test.html" class="btn btn-outline-secondary" target="_blank">Function Test</a>
                </div>
            </div>
        </div>

        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="image-tab" data-bs-toggle="tab" data-bs-target="#image" type="button" role="tab" aria-controls="image" aria-selected="true">Process Image</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="pdf-tab" data-bs-toggle="tab" data-bs-target="#pdf" type="button" role="tab" aria-controls="pdf" aria-selected="false">Process PDF</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="search-tab" data-bs-toggle="tab" data-bs-target="#search" type="button" role="tab" aria-controls="search" aria-selected="false">Search Archive</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="weather-tab" data-bs-toggle="tab" data-bs-target="#weather" type="button" role="tab" aria-controls="weather" aria-selected="false">Weather Data</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="results-tab" data-bs-toggle="tab" data-bs-target="#results" type="button" role="tab" aria-controls="results" aria-selected="false">Results</button>
            </li>
        </ul>

        <div class="tab-content" id="myTabContent">
            <!-- Image Processing Tab -->
            <div class="tab-pane fade show active" id="image" role="tabpanel" aria-labelledby="image-tab">
                <div class="card">
                    <div class="card-header">
                        <h5>Process Image</h5>
                    </div>
                    <div class="card-body">
                        <form id="imageForm">
                            <div class="mb-3">
                                <label for="imageFile" class="form-label">Upload Image</label>
                                <input class="form-control" type="file" id="imageFile" accept=".png,.jpg,.jpeg,.webp">
                            </div>
                            <button type="submit" class="btn btn-primary">Process</button>
                        </form>
                    </div>
                </div>
                <div id="imageResult" class="card d-none">
                    <div class="card-header">
                        <h5>Results</h5>
                    </div>
                    <div class="card-body">
                        <h6>Extracted Text:</h6>
                        <pre id="imageExtractedText" class="bg-light p-3 rounded"></pre>
                        <h6>Agent Output:</h6>
                        <pre id="imageAgentOutput" class="bg-light p-3 rounded"></pre>
                    </div>
                </div>
            </div>

            <!-- PDF Processing Tab -->
            <div class="tab-pane fade" id="pdf" role="tabpanel" aria-labelledby="pdf-tab">
                <div class="card">
                    <div class="card-header">
                        <h5>Process PDF</h5>
                    </div>
                    <div class="card-body">
                        <form id="pdfForm">
                            <div class="mb-3">
                                <label for="pdfFile" class="form-label">Upload PDF</label>
                                <input class="form-control" type="file" id="pdfFile" accept=".pdf">
                            </div>
                            <button type="submit" class="btn btn-primary">Process</button>
                        </form>
                    </div>
                </div>
                <div id="pdfResult" class="card d-none">
                    <div class="card-header">
                        <h5>Results</h5>
                    </div>
                    <div class="card-body">
                        <h6>Extracted Text:</h6>
                        <pre id="pdfExtractedText" class="bg-light p-3 rounded" style="max-height: 300px; overflow-y: auto;"></pre>
                        <h6>Agent Output:</h6>
                        <pre id="pdfAgentOutput" class="bg-light p-3 rounded"></pre>
                    </div>
                </div>
            </div>

            <!-- Search Archive Tab -->
            <div class="tab-pane fade" id="search" role="tabpanel" aria-labelledby="search-tab">
                <div class="card">
                    <div class="card-header">
                        <h5>Search Archive</h5>
                    </div>
                    <div class="card-body">
                        <form id="searchForm">
                            <div class="mb-3">
                                <label for="searchQuery" class="form-label">Search Query</label>
                                <input type="text" class="form-control" id="searchQuery" placeholder="Enter search terms...">
                            </div>
                            <button type="submit" class="btn btn-primary">Search</button>
                        </form>
                    </div>
                </div>
                <div id="searchResult" class="card d-none">
                    <div class="card-header">
                        <h5>Search Results</h5>
                    </div>
                    <div class="card-body">
                        <pre id="searchOutput" class="bg-light p-3 rounded"></pre>
                    </div>
                </div>
            </div>

            <!-- Weather Data Tab -->
            <div class="tab-pane fade" id="weather" role="tabpanel" aria-labelledby="weather-tab">
                <div class="card">
                    <div class="card-header">
                        <h5>Get Weather Data</h5>
                    </div>
                    <div class="card-body">
                        <form id="weatherForm">
                            <div class="mb-3">
                                <label for="location" class="form-label">Location</label>
                                <input type="text" class="form-control" id="location" placeholder="Enter city name..." value="London">
                            </div>
                            <button type="submit" class="btn btn-primary">Get Weather</button>
                        </form>
                    </div>
                </div>
                <div id="weatherResult" class="card d-none">
                    <div class="card-header">
                        <h5>Weather Results</h5>
                    </div>
                    <div class="card-body">
                        <div id="weatherOutput"></div>
                    </div>
                </div>
            </div>

            <!-- Results Tab -->
            <div class="tab-pane fade" id="results" role="tabpanel" aria-labelledby="results-tab">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>Recent Results</h5>
                        <button id="refreshResults" class="btn btn-sm btn-outline-primary">Refresh</button>
                    </div>
                    <div class="card-body results-container">
                        <div id="resultsList"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>Processing your request...</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Define API_BASE_URL directly in the HTML
        // Always use same origin (empty string) to avoid CORS issues
        window.API_BASE_URL = '';

        // For debugging, also store the original Render backend URL
        window.RENDER_BACKEND_URL = 'https://blackhole-core-api.onrender.com';

        // Log the configuration
        console.log('API_BASE_URL set to:', window.API_BASE_URL);
        console.log('RENDER_BACKEND_URL set to:', window.RENDER_BACKEND_URL);
        console.log('Hostname:', window.location.hostname);
        console.log('Origin:', window.location.origin);

        // API base URL for use in the script
        const API_BASE_URL = window.API_BASE_URL;

        // Check if the backend is available
        let backendAvailable = false;

        // Show loading indicator
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
        }

        // Hide loading indicator
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        // Format JSON for display
        function formatJSON(json) {
            return JSON.stringify(json, null, 2);
        }

        // Process image form submission
        document.getElementById('imageForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            if (!backendAvailable) {
                alert('Backend server is not available. Cannot process images.');
                return;
            }

            const fileInput = document.getElementById('imageFile');
            if (!fileInput.files.length) {
                alert('Please select an image file');
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            showLoading();
            try {
                const response = await fetch('/.netlify/functions/proxy/api/process-image', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if (response.ok) {
                    document.getElementById('imageExtractedText').textContent = data.extracted_text;
                    document.getElementById('imageAgentOutput').textContent = formatJSON(data.agent_result);
                    document.getElementById('imageResult').classList.remove('d-none');
                } else {
                    alert(`Error: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            } finally {
                hideLoading();
            }
        });

        // Process PDF form submission
        document.getElementById('pdfForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            if (!backendAvailable) {
                alert('Backend server is not available. Cannot process PDFs.');
                return;
            }

            const fileInput = document.getElementById('pdfFile');
            if (!fileInput.files.length) {
                alert('Please select a PDF file');
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            showLoading();
            try {
                const response = await fetch('/.netlify/functions/proxy/api/process-pdf', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if (response.ok) {
                    document.getElementById('pdfExtractedText').textContent = data.extracted_text;
                    document.getElementById('pdfAgentOutput').textContent = formatJSON(data.agent_result);
                    document.getElementById('pdfResult').classList.remove('d-none');
                } else {
                    alert(`Error: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            } finally {
                hideLoading();
            }
        });

        // Search form submission
        document.getElementById('searchForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            if (!backendAvailable) {
                alert('Backend server is not available. Cannot search the archive.');
                return;
            }

            const query = document.getElementById('searchQuery').value.trim();
            if (!query) {
                alert('Please enter a search query');
                return;
            }

            showLoading();
            try {
                const response = await fetch('/.netlify/functions/proxy/api/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ query })
                });
                const data = await response.json();

                if (response.ok) {
                    document.getElementById('searchOutput').textContent = formatJSON(data);
                    document.getElementById('searchResult').classList.remove('d-none');
                } else {
                    alert(`Error: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            } finally {
                hideLoading();
            }
        });

        // Weather form submission
        document.getElementById('weatherForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            if (!backendAvailable) {
                alert('Backend server is not available. Cannot get weather data.');
                return;
            }

            const location = document.getElementById('location').value.trim();
            if (!location) {
                alert('Please enter a location');
                return;
            }

            showLoading();
            try {
                const response = await fetch(`/.netlify/functions/proxy/api/weather?location=${encodeURIComponent(location)}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                const data = await response.json();

                if (response.ok) {
                    // Create a more user-friendly display of weather data
                    const weatherOutput = document.getElementById('weatherOutput');
                    weatherOutput.innerHTML = '';

                    if (data.output && data.output.current_condition && data.output.current_condition.length > 0) {
                        const current = data.output.current_condition[0];
                        const weatherHtml = `
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h5 class="card-title">Current Weather in ${location}</h5>
                                    <p class="card-text">Temperature: ${current.temp_C}¬∞C / ${current.temp_F}¬∞F</p>
                                    <p class="card-text">Feels Like: ${current.FeelsLikeC}¬∞C / ${current.FeelsLikeF}¬∞F</p>
                                    <p class="card-text">Weather: ${current.weatherDesc[0].value}</p>
                                    <p class="card-text">Humidity: ${current.humidity}%</p>
                                    <p class="card-text">Wind: ${current.windspeedKmph} km/h, ${current.winddir16Point}</p>
                                </div>
                            </div>
                        `;
                        weatherOutput.innerHTML = weatherHtml;
                    } else {
                        weatherOutput.textContent = formatJSON(data);
                    }

                    document.getElementById('weatherResult').classList.remove('d-none');
                } else {
                    alert(`Error: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            } finally {
                hideLoading();
            }
        });

        // Load results
        async function loadResults() {
            const resultsList = document.getElementById('resultsList');
            resultsList.innerHTML = '<p>Loading results...</p>';

            try {
                const response = await fetch(`${API_BASE_URL}/api/results`);
                const data = await response.json();

                if (response.ok && Array.isArray(data)) {
                    resultsList.innerHTML = '';

                    if (data.length === 0) {
                        resultsList.innerHTML = '<p>No results found.</p>';
                        return;
                    }

                    data.forEach(result => {
                        const resultItem = document.createElement('div');
                        resultItem.className = 'result-item';

                        const timestamp = new Date(result.timestamp).toLocaleString();
                        const agent = result.agent || 'Unknown';

                        let outputHtml = '';
                        if (result.output) {
                            if (Array.isArray(result.output)) {
                                outputHtml = `<pre>${formatJSON(result.output)}</pre>`;
                            } else if (typeof result.output === 'object') {
                                outputHtml = `<pre>${formatJSON(result.output)}</pre>`;
                            } else {
                                outputHtml = `<p>${result.output}</p>`;
                            }
                        }

                        resultItem.innerHTML = `
                            <h6>${agent} - ${timestamp}</h6>
                            <p><strong>Input:</strong> ${formatJSON(result.input)}</p>
                            <div><strong>Output:</strong> ${outputHtml}</div>
                        `;

                        resultsList.appendChild(resultItem);
                    });
                } else {
                    resultsList.innerHTML = `<p>Error loading results: ${data.error || 'Unknown error'}</p>`;
                }
            } catch (error) {
                resultsList.innerHTML = `<p>Error loading results: ${error.message}</p>`;
            }
        }

        // Refresh results button
        document.getElementById('refreshResults').addEventListener('click', loadResults);

        // Load results when tab is shown
        document.getElementById('results-tab').addEventListener('click', loadResults);

        // Test connection button
        document.getElementById('testConnectionBtn').addEventListener('click', async function() {
            const resultDiv = document.getElementById('testConnectionResult');
            resultDiv.innerHTML = '<div class="alert alert-info">Testing connection to backend...</div>';

            // First try the Netlify function directly
            try {
                const response = await fetch('/.netlify/functions/test', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                const responseHeaders = {};
                response.headers.forEach((value, name) => {
                    responseHeaders[name] = value;
                });

                const responseText = await response.text();
                let data;

                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    throw new Error(`Invalid JSON response: ${responseText.substring(0, 100)}...`);
                }

                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <h5>‚úÖ Netlify Function Test Successful!</h5>
                            <p>Status: ${response.status}</p>
                            <p>Message: ${data.message}</p>
                            <p>Timestamp: ${data.timestamp}</p>
                            <h6>Debug Information:</h6>
                            <pre class="bg-light p-2 mt-2" style="font-size: 0.8rem;">
window.API_BASE_URL: ${window.API_BASE_URL || 'not set'}

API_BASE_URL variable: ${API_BASE_URL}

window.location.hostname: ${window.location.hostname}

window.location.origin: ${window.location.origin}

Response Headers: ${JSON.stringify(responseHeaders, null, 2)}

Response Data: ${JSON.stringify(data, null, 2)}
                            </pre>
                        </div>
                    `;

                    // Now try the proxy function
                    resultDiv.innerHTML += '<div class="alert alert-info mt-3">Testing connection to backend via proxy...</div>';

                    try {
                        const proxyResponse = await fetch('/.netlify/functions/proxy/api/health', {
                            method: 'GET',
                            headers: {
                                'Accept': 'application/json'
                            }
                        });

                        const proxyResponseHeaders = {};
                        proxyResponse.headers.forEach((value, name) => {
                            proxyResponseHeaders[name] = value;
                        });

                        const proxyResponseText = await proxyResponse.text();
                        let proxyData;

                        try {
                            proxyData = JSON.parse(proxyResponseText);
                        } catch (e) {
                            throw new Error(`Invalid JSON response from proxy: ${proxyResponseText.substring(0, 100)}...`);
                        }

                        if (proxyResponse.ok) {
                            resultDiv.innerHTML += `
                                <div class="alert alert-success mt-3">
                                    <h5>‚úÖ Proxy Function Test Successful!</h5>
                                    <p>Status: ${proxyResponse.status}</p>
                                    <p>MongoDB: ${proxyData.mongodb}</p>
                                    <h6>Debug Information:</h6>
                                    <pre class="bg-light p-2 mt-2" style="font-size: 0.8rem;">
Response Headers: ${JSON.stringify(proxyResponseHeaders, null, 2)}

Response Data: ${JSON.stringify(proxyData, null, 2)}
                                    </pre>
                                </div>
                            `;
                            backendAvailable = true;
                        } else {
                            resultDiv.innerHTML += `
                                <div class="alert alert-warning mt-3">
                                    <h5>‚ö†Ô∏è Proxy Function Warning</h5>
                                    <p>Status: ${proxyResponse.status}</p>
                                    <h6>Debug Information:</h6>
                                    <pre class="bg-light p-2 mt-2" style="font-size: 0.8rem;">
Response Headers: ${JSON.stringify(proxyResponseHeaders, null, 2)}

Response Data: ${JSON.stringify(proxyData, null, 2)}
                                    </pre>
                                </div>
                            `;
                            backendAvailable = false;
                        }
                    } catch (proxyError) {
                        resultDiv.innerHTML += `
                            <div class="alert alert-danger mt-3">
                                <h5>‚ùå Proxy Function Failed: ${proxyError.message}</h5>
                                <h6>Debug Information:</h6>
                                <pre class="bg-light p-2 mt-2" style="font-size: 0.8rem;">
Error details: ${proxyError}
                                </pre>
                            </div>
                        `;
                        backendAvailable = false;
                    }
                } else {
                    resultDiv.innerHTML = `
                        <div class="alert alert-warning">
                            <h5>‚ö†Ô∏è Netlify Function Warning</h5>
                            <p>Status: ${response.status}</p>
                            <h6>Debug Information:</h6>
                            <pre class="bg-light p-2 mt-2" style="font-size: 0.8rem;">
window.API_BASE_URL: ${window.API_BASE_URL || 'not set'}

API_BASE_URL variable: ${API_BASE_URL}

window.location.hostname: ${window.location.hostname}

window.location.origin: ${window.location.origin}

Response Headers: ${JSON.stringify(responseHeaders, null, 2)}

Response Data: ${JSON.stringify(data, null, 2)}
                            </pre>
                        </div>
                    `;
                    backendAvailable = false;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h5>‚ùå Connection failed: ${error.message}</h5>
                        <h6>Debug Information:</h6>
                        <pre class="bg-light p-2 mt-2" style="font-size: 0.8rem;">
window.API_BASE_URL: ${window.API_BASE_URL || 'not set'}

API_BASE_URL variable: ${API_BASE_URL}

window.location.hostname: ${window.location.hostname}

window.location.origin: ${window.location.origin}

Error details: ${error}
                        </pre>
                    </div>
                `;
                backendAvailable = false;

                // Add a message to all tabs
                const tabContents = document.querySelectorAll('.tab-pane');
                tabContents.forEach(tab => {
                    if (!tab.querySelector('.backend-error-message')) {
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'alert alert-danger backend-error-message mt-3';
                        errorDiv.innerHTML = `
                            <h5>Backend Connection Error</h5>
                            <p>Cannot connect to the backend server. This is expected if you're viewing a static deployment without a running backend.</p>
                            <p>To use all features, you need to:</p>
                            <ol>
                                <li>Deploy the backend server (see README.md)</li>
                                <li>Update the API_BASE_URL in this file to point to your backend</li>
                            </ol>
                            <p><a href="static-demo.html" class="btn btn-sm btn-primary">View Static Demo</a></p>
                        `;
                        tab.prepend(errorDiv);
                    }
                });
            }
        });

        // Initial health check
        async function checkHealth() {
            try {
                // First check if the Netlify functions are working
                try {
                    const testResponse = await fetch('/.netlify/functions/test', {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json'
                        }
                    });

                    if (testResponse.ok) {
                        console.log('Netlify functions are working.');
                    } else {
                        console.warn('Netlify functions may not be working properly.');
                    }
                } catch (testError) {
                    console.error('Error testing Netlify functions:', testError);
                }

                // Now check the backend via the proxy
                const response = await fetch('/.netlify/functions/proxy/api/health', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                const responseText = await response.text();
                let data;

                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    console.error('Invalid JSON response:', responseText);
                    throw new Error(`Invalid JSON response: ${responseText.substring(0, 100)}...`);
                }

                if (!response.ok || data.mongodb !== 'connected') {
                    console.warn('Warning: Backend services may not be fully operational.');
                    document.getElementById('resultsList').innerHTML = '<div class="alert alert-warning">Backend services may not be fully operational. MongoDB connection issue detected.</div>';
                    backendAvailable = false;
                } else {
                    console.log('Backend services are operational.');
                    backendAvailable = true;
                }
            } catch (error) {
                console.error('Error connecting to backend services:', error);
                document.getElementById('resultsList').innerHTML = '<div class="alert alert-danger">Error connecting to backend services. The server may not be running or is not accessible.</div>';
                backendAvailable = false;
            }
        }

        // Load results with backend availability check
        async function loadResults() {
            const resultsList = document.getElementById('resultsList');

            if (!backendAvailable) {
                resultsList.innerHTML = '<div class="alert alert-warning">Backend server is not available. Cannot load results.</div>';
                return;
            }

            resultsList.innerHTML = '<p>Loading results...</p>';

            try {
                const response = await fetch('/.netlify/functions/proxy/api/results', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                const data = await response.json();

                if (response.ok && Array.isArray(data)) {
                    resultsList.innerHTML = '';

                    if (data.length === 0) {
                        resultsList.innerHTML = '<p>No results found.</p>';
                        return;
                    }

                    data.forEach(result => {
                        const resultItem = document.createElement('div');
                        resultItem.className = 'result-item';

                        const timestamp = new Date(result.timestamp).toLocaleString();
                        const agent = result.agent || 'Unknown';

                        let outputHtml = '';
                        if (result.output) {
                            if (Array.isArray(result.output)) {
                                outputHtml = `<pre>${formatJSON(result.output)}</pre>`;
                            } else if (typeof result.output === 'object') {
                                outputHtml = `<pre>${formatJSON(result.output)}</pre>`;
                            } else {
                                outputHtml = `<p>${result.output}</p>`;
                            }
                        }

                        resultItem.innerHTML = `
                            <h6>${agent} - ${timestamp}</h6>
                            <p><strong>Input:</strong> ${formatJSON(result.input)}</p>
                            <div><strong>Output:</strong> ${outputHtml}</div>
                        `;

                        resultsList.appendChild(resultItem);
                    });
                } else {
                    resultsList.innerHTML = `<p>Error loading results: ${data.error || 'Unknown error'}</p>`;
                }
            } catch (error) {
                resultsList.innerHTML = `<p>Error loading results: ${error.message}</p>`;
            }
        }

        // Test backend connection button
        document.getElementById('testConnectionBtn').addEventListener('click', async function() {
            const resultDiv = document.getElementById('testConnectionResult');
            resultDiv.innerHTML = '<div class="alert alert-info">Testing connection...</div>';

            try {
                const response = await fetch(`${API_BASE_URL}/test-connection`);

                if (response.ok) {
                    const data = await response.json();
                    resultDiv.innerHTML = `<div class="alert alert-success">
                        Connection successful! Server time: ${data.timestamp}
                    </div>`;
                    backendAvailable = true;
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    resultDiv.innerHTML = `<div class="alert alert-danger">
                        Error: ${errorData.error || 'Unknown error'} (Status: ${response.status})
                    </div>`;
                    backendAvailable = false;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-danger">
                    Connection failed: ${error.message}
                </div>
                <div class="alert alert-info">
                    API_BASE_URL: ${API_BASE_URL}
                </div>
                <div class="mt-2">
                    <button id="showDebugInfo" class="btn btn-sm btn-outline-secondary">Show Debug Info</button>
                    <div id="debugInfo" class="mt-2" style="display: none;"></div>
                </div>`;

                document.getElementById('showDebugInfo').addEventListener('click', function() {
                    const debugInfo = document.getElementById('debugInfo');
                    debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';

                    if (debugInfo.style.display === 'block') {
                        debugInfo.innerHTML = `
                            <div class="card">
                                <div class="card-header">Debug Information</div>
                                <div class="card-body">
                                    <p><strong>window.API_BASE_URL:</strong> ${window.API_BASE_URL || 'not set'}</p>
                                    <p><strong>API_BASE_URL variable:</strong> ${API_BASE_URL}</p>
                                    <p><strong>window.location.hostname:</strong> ${window.location.hostname}</p>
                                    <p><strong>window.location.origin:</strong> ${window.location.origin}</p>
                                    <p><strong>Error details:</strong> ${error.toString()}</p>
                                </div>
                            </div>
                        `;
                    }
                });

                backendAvailable = false;
            }
        });

        // Run health check on page load
        window.addEventListener('load', checkHealth);
    </script>
</body>
</html>
